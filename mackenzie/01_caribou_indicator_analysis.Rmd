---
title: "caribou_indicator_analysis"
author: "Tyler Muhly"
date: "17/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (keyring)
library (DBI)
library (RPostgreSQL)
library (sf)
library (raster)
library (rgrass7)




library (fasterize)


library (data.table)
```

## Mackenzie Timber Supply Review Caribou Indicator Analysis
Here I calculate indicators of caribou habitat 'disturbance' to support the Mackenzie timber supply review. Caribou are a species of concern to First Nations in the region, and to the governments of British Columbia and Canada. First Nations requested an analysis to assess the potential influence of future simulated forest harvest on caribou, using the indicators described here  

'Disturbance' is defined here as areas of caribou range that have been modified by forestry (i.e., areas within 500 m of roads or forestry cutblocks) or burned in the last 40 years. These disturbances have been negatively correlated with caribou survival rates and population abundance, and therefore are often used to indicate the effects of habitat change caused by land use and fire on caribou populations. Other disturbances (e.g., mountain pine beetle or other industrial activities like oil and gas or mining development) also negatively influence caribou, but we do not account for them here, and focus exclusively on fire and forestry here because forestry is the scope of the timber supply review and future forestry and fire can be simulated with the timber supply simulation model. 

Also note that the analysis here focuses exclusively on the hypothetical influence of forestry development and fire on caribou habitat. We do not analyze or discuss the potential influence of population management actions, such as maternity pens or wolf reduction, on caribou populations.  

## Methods
We took simulated forestry and fire disturbance outputs at 10 year intervals over a 70 year period into the future from a SELES/STSM timber supply model. The outputs included the location and timing of cutblocks, roads and fires. 

```{r load and prep the data}

conn <- DBI::dbConnect (PostgreSQL(), 
                        host = keyring::key_get('dbhost', keyring = 'postgreSQL'), 
                        dbname = keyring::key_get('dbname', keyring = 'postgreSQL'), 
                        port='5432',
                        user=keyring::key_get('dbuser', keyring = 'postgreSQL') ,
                        password= keyring::key_get('dbpass', keyring = 'postgreSQL'))

## timber supply areas
sf.mac.tsa.bounds <- st_read (dsn = "D:/tsr/mackenzie/data/mackenzie_tsa.shp")

## caribou critical habitat
sf.bc.crit <- st_read (conn, 
                    query = "SELECT * from bc_critical_habitat_all_herds_20200615;") 

## watershed areas
sf.awa <- st_read (dsn = "D:/tsr/mackenzie/data/fwa_assessment_watershed_poly.shp")


## current roads
ras.roads.2020 <- raster ("D:/tsr/mackenzie/data/Current_Roads2020.tif")
ras.roads.2020 <- raster::reclassify (ras.roads.2020, c (1,3,1, 4,Inf,0)) # reclass

## future simulated roads
ras.roads.sim <- raster ("D:/tsr/mackenzie/data/road_state_7.tif")
ras.roads.sim <- ras.roads.sim - 329 # changes value to decade of development
ras.roads.sim <- raster::reclassify (ras.roads.sim, c (-Inf,0,0))

## all roads
ras.roads.all <- ras.roads.sim + ras.roads.2020


## existing fires
ras.fire.current <- raster ("D:/tsr/mackenzie/data/tsa16_fire_age.tif")

## future burned areas
ras.fire.sim <- raster ("D:/tsr/mackenzie/data/Disturbed_1_7.tif")
ras.fire.sim <- ras.fire.sim - 329 # changes value to decade of fire
ras.fire.sim <- raster::reclassify (ras.fire.sim, c (-Inf,0,0)) 


## existing cutblocks
ras.cut.current <- raster ("D:/tsr/mackenzie/data/tsa16_cutblock_age.tif")

## future logged areas
ras.cut.sim <- raster ("D:/tsr/mackenzie/data/Logged_1_7.tif")
ras.cut.sim <- ras.cut.sim - 329 # changes value to decade of logging
ras.cut.sim <- raster::reclassify (ras.cut.sim, c (-Inf,0,0)) 

```

We then buffered the roads and less than 40 years old cutblocks by 500m at each decade. Note that roads at the start of the simulation had no associated development dates, and we did not estimate a time period for road recovery, therefore all existing roads and simulated future roads were included as disturbance.


```{r total disturbance by decade}

## 2020 (current)
m <- c (1,40,1, 40,Inf,0) # matrix to make 1 to 40 pixels = 1, else = 0
ras.fire.current.40 <- raster::reclassify (ras.fire.current, # class of 40 year-old burns
                                           m)
ras.cut.current.40  <- raster::reclassify (ras.cut.current, # class of 40 year-old cutblocks
                                           m)
ras.cut.road <- ras.cut.current.40 + ras.roads.2020 # disturbances that need a buffer
#ras.cut.road [ras.cut.road == 0] <- NA # make 0's NA's for buffering
ras.cut.road [ras.cut.road > 1] <- 1 # reclass
### here decided to buffer with GRASS r.buffer function; the raster::buffer() function is very slow....
### to to this I saved geotiff to open in QGIS; 
### alternatively, I tired to call grass functions from R using rgrass7 package (see https://gis.stackexchange.com/questions/150121/use-grass-through-r)
### But this wasn't straightforward as it requires setting environmental variables (see https://gis.stackexchange.com/questions/377481/unable-to-execute-grass-7-8-in-rstudio)
### I played with this, couldn't get it to work, and gave up......
writeRaster (ras.cut.road, "D:\\tsr\\mackenzie\\data\\ras_cut_road.tif", format = "GTiff", overwrite=TRUE)
ras.2020.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2020_cut_road_buff.tif") # the buffered raster
ras.2020.cut.road.buff [ras.2020.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2020.cut.road.buff [is.na (ras.2020.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2020.disturb <- ras.fire.current.40 + ras.2020.cut.road.buff
ras.2020.disturb [ras.2020.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2020.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2020.tif", format = "GTiff", overwrite=TRUE)


## 2030
m <- c (1,30,1, 30,Inf,0) # matrix to make 1 to 30 pixels = 1, else = 0; anything current >30 years old ages out at 2030
### in 2030 cutblocks that were aged 0-30 in 2020 are now 11-40 and count as disturbance; anything older than that is aged out
ras.fire.current.30 <- raster::reclassify (ras.fire.current, # cutblocks 1990 to 2020
                                           m)
ras.fire.new.2030 <- raster::reclassify (ras.fire.sim, # fires 2020 to 2030
                                        c (11,11,1, 11,Inf,0))
ras.cut.current.30 <- raster::reclassify (ras.cut.current, # class of 40 year-old cutblocks
                                           m)
ras.cut.new.2030 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2020 to 2030
                                        c (11,11,1, 11,Inf,0))
ras.roads.new.2030 <- raster::reclassify (ras.roads.sim, # roads built 2020 to 2030
                                          c (11,11,1, 11,Inf,0))
ras.cut.road.2030 <- ras.cut.new.2030 + ras.cut.current.30 + ras.roads.new.2030 + ras.roads.2020
ras.cut.road.2030 [ras.cut.road.2030 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2030, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2030.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2030.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2030_cut_road_buff.tif") # the buffered raster
ras.2030.cut.road.buff [ras.2030.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2030.cut.road.buff [is.na (ras.2030.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2030.disturb <- ras.fire.current.30 + ras.fire.new.2030 + ras.2030.cut.road.buff
ras.2030.disturb [ras.2030.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2030.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2030.tif", format = "GTiff", overwrite=TRUE)


## 2040
m <- c (1,20,1, 20,Inf,0) # matrix to make 1 to 20 pixels = 1, else = 0; anything current >20 years old ages out at 2040
ras.fire.current.20 <- raster::reclassify (ras.fire.current, # fire 2000 to 2020
                                           m)
ras.fire.new.2040 <- raster::reclassify (ras.fire.sim, # fires 2020 to 2040
                                        c (11,21,1, 21,Inf,0))
ras.cut.current.20 <- raster::reclassify (ras.cut.current, # cutblocks 2000 to 2020
                                           m)
ras.cut.new.2040 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2030 to 2040
                                        c (11,21,1, 21,Inf,0))
ras.roads.new.2040 <- raster::reclassify (ras.roads.sim, # roads built 2020 to 2040
                                          c (11,21,1, 21,Inf,0))
ras.cut.road.2040 <- ras.cut.new.2040 + ras.cut.current.20 + ras.roads.new.2040 + ras.roads.2020
ras.cut.road.2040 [ras.cut.road.2040 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2040, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2040.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2040.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2040_cut_road_buff.tif") # the buffered raster
ras.2040.cut.road.buff [ras.2040.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2040.cut.road.buff [is.na (ras.2040.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2040.disturb <- ras.fire.current.20 + ras.fire.new.2040 + ras.2040.cut.road.buff
ras.2040.disturb [ras.2040.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2040.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2040.tif", format = "GTiff", overwrite=TRUE)


## 2050
m <- c (1,10,1, 10,Inf,0) # matrix to make 1 to 20 pixels = 1, else = 0; anything current >20 years old ages out at 2050
ras.fire.current.10 <- raster::reclassify (ras.fire.current, # fire 2010 to 2020
                                           m)
ras.fire.new.2050 <- raster::reclassify (ras.fire.sim, # fires 2020 to 2050
                                        c (11,31,1, 31,Inf,0))
ras.cut.current.10 <- raster::reclassify (ras.cut.current, # cutblocks 2010 to 2020
                                           m)
ras.cut.new.2050 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2030 to 2050
                                        c (11,31,1, 31,Inf,0))
ras.roads.new.2050 <- raster::reclassify (ras.roads.sim, # roads built 2020 to 2050
                                          c (11,31,1, 31,Inf,0))
ras.cut.road.2050 <- ras.cut.new.2050 + ras.cut.current.10 + ras.roads.new.2050 + ras.roads.2020
ras.cut.road.2050 [ras.cut.road.2050 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2050, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2050.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2050.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2050_cut_road_buff.tif") # the buffered raster
ras.2050.cut.road.buff [ras.2050.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2050.cut.road.buff [is.na (ras.2050.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2050.disturb <- ras.fire.current.10 + ras.fire.new.2050 + ras.2050.cut.road.buff
ras.2050.disturb [ras.2050.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2050.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2050.tif", format = "GTiff", overwrite=TRUE)


## 2060
ras.fire.new.2060 <- raster::reclassify (ras.fire.sim, # fires 2020 to 2060
                                        c (11,41,1, 41,Inf,0))
ras.cut.new.2060 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2030 to 2060
                                        c (11,41,1, 41,Inf,0))
ras.roads.new.2060 <- raster::reclassify (ras.roads.sim, # roads built 2020 to 2060
                                          c (11,41,1, 41,Inf,0))
ras.cut.road.2060 <- ras.cut.new.2060 + ras.roads.new.2060 + ras.roads.2020
ras.cut.road.2060 [ras.cut.road.2060 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2060, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2060.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2060.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2060_cut_road_buff.tif") # the buffered raster
ras.2060.cut.road.buff [ras.2060.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2060.cut.road.buff [is.na (ras.2060.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2060.disturb <- ras.fire.new.2060 + ras.2060.cut.road.buff
ras.2060.disturb [ras.2060.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2060.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2060.tif", format = "GTiff", overwrite=TRUE)

## 2070
ras.fire.new.2070 <- raster::reclassify (ras.fire.sim, # fires 2030 to 2070
                                        c (21,51,1, 51,Inf,0))
ras.cut.new.2070 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2030 to 2070
                                        c (21,51,1, 51,Inf,0))
ras.roads.new.2070 <- raster::reclassify (ras.roads.sim, # roads built 2030 to 2070
                                          c (21,51,1, 51,Inf,0))
ras.cut.road.2070 <- ras.cut.new.2070 + ras.roads.new.2070 + ras.roads.2020
ras.cut.road.2070 [ras.cut.road.2070 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2070, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2070.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2070.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2070_cut_road_buff.tif") # the buffered raster
ras.2070.cut.road.buff [ras.2070.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2070.cut.road.buff [is.na (ras.2070.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2070.disturb <- ras.fire.new.2070 + ras.2070.cut.road.buff
ras.2070.disturb [ras.2070.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2070.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2070.tif", format = "GTiff", overwrite=TRUE)


## 2080
ras.fire.new.2080 <- raster::reclassify (ras.fire.sim, # fires 2040 to 2080
                                        c (31,61,1, 61,Inf,0))
ras.cut.new.2080 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2040 to 2080
                                        c (31,61,1, 61,Inf,0))
ras.roads.new.2080 <- raster::reclassify (ras.roads.sim, # roads built 2040 to 2080
                                          c (31,61,1, 61,Inf,0))
ras.cut.road.2080 <- ras.cut.new.2080 + ras.roads.new.2080 + ras.roads.2020
ras.cut.road.2080 [ras.cut.road.2080 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2080, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2080.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2080.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2080_cut_road_buff.tif") # the buffered raster
ras.2080.cut.road.buff [ras.2080.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2080.cut.road.buff [is.na (ras.2080.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2080.disturb <- ras.fire.new.2080 + ras.2080.cut.road.buff
ras.2080.disturb [ras.2080.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2080.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2080.tif", format = "GTiff", overwrite=TRUE)


## 2090
ras.fire.new.2090 <- raster::reclassify (ras.fire.sim, # fires 2050 to 2090
                                        c (41,71,1, 71,Inf,0))
ras.cut.new.2090 <- raster::reclassify (ras.cut.sim, # cutblocks cut 2050 to 2090
                                        c (41,71,1, 71,Inf,0))
ras.roads.new.2090 <- raster::reclassify (ras.roads.sim, # roads built 2050 to 2090
                                          c (41,71,1, 71,Inf,0))
ras.cut.road.2090 <- ras.cut.new.2090 + ras.roads.new.2090 + ras.roads.2020
ras.cut.road.2090 [ras.cut.road.2090 > 1] <- 1 # reclass
writeRaster (ras.cut.road.2090, "D:\\tsr\\mackenzie\\data\\ras_cut_road_2090.tif", format = "GTiff", overwrite=TRUE) # buffer in QGIS...
ras.2090.cut.road.buff <- raster ("D:/tsr/mackenzie/data/ras_2090_cut_road_buff.tif") # the buffered raster
ras.2090.cut.road.buff [ras.2090.cut.road.buff > 1] <- 1 # '2' are buffered areas; reclass to '1'
ras.2090.cut.road.buff [is.na (ras.2090.cut.road.buff [])] <- 0 # make NA's = 0
### add buffered disturbance to fire disturbance
ras.2090.disturb <- ras.fire.new.2090 + ras.2090.cut.road.buff
ras.2090.disturb [ras.2090.disturb > 1] <- 1 # reclass again...
writeRaster (ras.2090.disturb, "D:\\tsr\\mackenzie\\data\\ras_disturb_2090.tif", format = "GTiff", overwrite=TRUE)









ras.cut.road.buff <- raster::buffer(ras.cut.road, width = 500) # buffer roads and cutblocks




writeRaster (ras.2030.cut.road.buff, "D:\\tsr\\mackenzie\\data\\test.tif", format="GTiff", overwrite=TRUE)



plot (ras.2040.cut.road.buff)
mapview::mapview(ras.cut.current.30)


hist(ras.cut.current.40)
hist(ras.2020.disturb,
      breaks = c(0, 1))


hist(ras.roads.all,
      breaks = c(0, 1, 10, 20, 30, 40, 50, 60, 70, 80))



```


 summarized the amount of disturbance in caribou critical habitat, by decade, form 2020 to 2090
